<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Convert HEIC to JPG, PNG, WebP, GIF, or BMP locally in your browser. No uploads, no accounts.">
  <meta name="keywords" content="heic to jpg, heic to png, heic to webp, heic to gif, heic to bmp, iphone heic converter, heic converter online, no upload">
  <meta name="robots" content="index,follow">
  <link rel="icon" type="image/png" href="/logo.png">
  <link rel="apple-touch-icon" href="/logo.png">

  <link rel="canonical" href="https://docdeskew.com/heic/">
  <link rel="alternate" hreflang="en" href="https://docdeskew.com/heic/?lang=en">
  <link rel="alternate" hreflang="ja" href="https://docdeskew.com/heic/?lang=ja">
  <link rel="alternate" hreflang="zh-Hans" href="https://docdeskew.com/heic/?lang=zh-hans">
  <link rel="alternate" hreflang="zh-Hant" href="https://docdeskew.com/heic/?lang=zh-hant">
  <link rel="alternate" hreflang="es" href="https://docdeskew.com/heic/?lang=es">
  <link rel="alternate" hreflang="ko" href="https://docdeskew.com/heic/?lang=ko">
  <link rel="alternate" hreflang="ru" href="https://docdeskew.com/heic/?lang=ru">
  <link rel="alternate" hreflang="ar" href="https://docdeskew.com/heic/?lang=ar">
  <link rel="alternate" hreflang="x-default" href="https://docdeskew.com/heic/">

  <meta property="og:type" content="website">
  <meta property="og:site_name" content="DocDeskew">
  <meta property="og:title" content="HEIC to JPG/PNG/WebP/GIF/BMP Converter | DocDeskew">
  <meta property="og:description" content="Convert HEIC photos to JPG, PNG, WebP, GIF, or BMP locally in your browser. No uploads, no accounts.">
  <meta property="og:url" content="https://docdeskew.com/heic/">
  <meta property="og:image" content="https://docdeskew.com/doc_en.jpg">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="HEIC to JPG/PNG/WebP/GIF/BMP Converter | DocDeskew">
  <meta name="twitter:description" content="Convert HEIC photos to JPG, PNG, WebP, GIF, or BMP locally in your browser. No uploads, no accounts.">
  <meta name="twitter:image" content="https://docdeskew.com/doc_en.jpg">

  <meta name="theme-color" content="#15162b">
  <title>HEIC to JPG/PNG/WebP/GIF/BMP Converter | DocDeskew</title>

  <style>
    :root {
      color-scheme: dark;
      --bg: #15162b;
      --panel: rgba(22, 33, 62, 0.95);
      --panel-soft: rgba(15, 15, 35, 0.8);
      --text: #e8e8f3;
      --muted: rgba(232, 232, 243, 0.7);
      --outline: rgba(255,255,255,0.12);
      --accent: #48bb78;
    }

    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      background: radial-gradient(circle at top, rgba(102, 126, 234, 0.16), transparent 55%),
        radial-gradient(circle at 20% 20%, rgba(72, 187, 120, 0.12), transparent 45%),
        var(--bg);
      color: var(--text);
    }

    a { color: inherit; text-decoration: none; }

    .privacy-banner {
      position: sticky;
      top: 0;
      z-index: 1100;
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: rgba(15, 15, 35, 0.92);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
    }

    .brand {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 900;
      letter-spacing: 0.4px;
    }

    .brand-logo {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      object-fit: contain;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
    }

    .top-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .nav-link,
    .privacy-link {
      font-size: 13px;
      color: #cfd6ff;
      text-decoration: none;
      border-bottom: 1px dashed rgba(207, 214, 255, 0.35);
      white-space: nowrap;
    }

    .lang-select {
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      font-size: 13px;
      background: rgba(15, 15, 35, 0.9);
      color: #fff;
      max-width: 210px;
    }

    .container {
      max-width: 1120px;
      margin: 0 auto;
      padding: 26px 20px 40px;
    }

    .hero {
      display: grid;
      gap: 12px;
      padding: 20px 24px;
      border-radius: 18px;
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
      margin-bottom: 20px;
    }

    .hero h1 { margin: 0; font-size: clamp(26px, 4vw, 38px); }

    .hero p { margin: 0; color: var(--muted); font-size: 15px; line-height: 1.6; }

    .hero-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15, 15, 35, 0.7);
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 12px;
      font-weight: 800;
    }

    .converter {
      display: grid;
      gap: 16px;
      grid-template-columns: minmax(260px, 360px) 1fr;
      align-items: start;
    }

    .panel {
      background: var(--panel);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
    }

    .panel h2 {
      margin: 0 0 12px;
      font-size: 16px;
      font-weight: 900;
    }

    .file-input {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    .file-drop {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 22px;
      border-radius: 14px;
      border: 2px dashed rgba(255,255,255,0.16);
      background: rgba(15, 15, 35, 0.6);
      text-align: center;
      cursor: pointer;
      transition: border-color 0.18s ease, background 0.18s ease;
    }

    .file-drop.drag {
      border-color: var(--accent);
      background: rgba(72, 187, 120, 0.12);
    }

    .file-drop-title {
      font-weight: 800;
      font-size: 14px;
    }

    .file-drop-note {
      font-size: 12px;
      color: var(--muted);
    }

    .file-summary {
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .file-names {
      display: grid;
      gap: 4px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
    }

    .file-name-item {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-preview {
      display: grid;
      gap: 10px;
      margin-top: 12px;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    }

    .file-preview-item {
      display: grid;
      gap: 6px;
      padding: 8px;
      border-radius: 12px;
      background: rgba(15, 15, 35, 0.6);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .file-thumb {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 10px;
      background: #0b0b18;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
      overflow: hidden;
    }

    .file-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .file-preview-name {
      font-size: 11px;
      color: var(--muted);
      word-break: break-all;
    }

    .options {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }

    .option label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    select,
    input[type="range"] {
      width: 100%;
    }

    select {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(15, 15, 35, 0.9);
      color: #fff;
      font-size: 13px;
    }

    .quality-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .quality-value {
      font-size: 12px;
      color: var(--muted);
      min-width: 44px;
      text-align: right;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 13px;
      font-weight: 900;
      cursor: pointer;
      color: #fff;
      background: rgba(255,255,255,0.08);
    }

    .btn.primary {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      border-color: rgba(72, 187, 120, 0.45);
    }

    .status {
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
    }

    .results-empty {
      color: var(--muted);
      font-size: 13px;
      padding: 12px 0 4px;
    }

    .results-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .result-item {
      display: grid;
      gap: 8px;
      padding: 10px;
      border-radius: 12px;
      background: rgba(15, 15, 35, 0.6);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .result-item img {
      width: 100%;
      border-radius: 8px;
      background: #0b0b18;
      aspect-ratio: 4 / 3;
      object-fit: contain;
    }

    .result-meta {
      display: grid;
      gap: 4px;
      font-size: 12px;
    }

    .result-name {
      font-weight: 700;
      word-break: break-all;
    }

    .result-size {
      color: var(--muted);
    }

    .result-download {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(102, 126, 234, 0.35);
      background: rgba(102, 126, 234, 0.18);
      font-weight: 800;
      font-size: 12px;
      color: #fff;
      cursor: pointer;
      text-decoration: none;
    }

    .footer {
      margin-top: 28px;
      text-align: center;
      font-size: 12px;
      color: rgba(255,255,255,0.55);
      padding: 0 12px 26px;
    }

    .cookie-banner {
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      margin: 0 auto;
      max-width: 980px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-radius: 14px;
      background: rgba(15, 15, 35, 0.95);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.45);
      z-index: 1400;
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      transition: opacity 0.18s ease, transform 0.18s ease;
    }

    .cookie-banner.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .cookie-text {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
      color: rgba(255,255,255,0.82);
      font-size: 13px;
      line-height: 1.45;
    }

    .cookie-text strong { color: #fff; font-weight: 900; }

    .cookie-link {
      color: #cfd6ff;
      text-decoration: none;
      border-bottom: 1px dashed rgba(207, 214, 255, 0.35);
      width: fit-content;
    }

    .cookie-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex: 0 0 auto;
    }

    .cookie-btn {
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,0.12);
      cursor: pointer;
      white-space: nowrap;
      background: rgba(255,255,255,0.08);
      color: #fff;
    }

    .cookie-btn.primary {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      border-color: rgba(72, 187, 120, 0.45);
    }

    @media (max-width: 900px) {
      .converter { grid-template-columns: 1fr; }
    }

    @media (max-width: 820px) {
      .container { padding: 18px 14px 34px; }
      .actions { flex-direction: column; }
      .cookie-banner { left: 10px; right: 10px; }
      .cookie-actions { width: 100%; justify-content: flex-end; }
      .cookie-btn { flex: 1 1 0; }
    }
  </style>
</head>

<body>
  <div class="privacy-banner" role="note">
    <div class="brand">
      <img class="brand-logo" src="/logo.png" alt="DocDeskew logo">
      <a href="../">DocDeskew</a>
    </div>
    <div class="top-actions">
      <a class="nav-link" href="../" data-i18n="nav.home">Home</a>
      <a class="privacy-link" href="../privacy.html" data-i18n="privacy.link">Privacy</a>
      <select id="languageSelect" class="lang-select" aria-label="Language">
        <option value="en" data-i18n="language.en">English</option>
        <option value="ja" data-i18n="language.ja">日本語</option>
        <option value="zh-hans" data-i18n="language.zhHans">简体中文</option>
        <option value="zh-hant" data-i18n="language.zhHant">繁體中文</option>
        <option value="es" data-i18n="language.es">Español</option>
        <option value="ko" data-i18n="language.ko">한국어</option>
        <option value="ru" data-i18n="language.ru">Русский</option>
        <option value="ar" data-i18n="language.ar">العربية</option>
      </select>
    </div>
  </div>

  <main class="container">
    <section class="hero">
      <h1 data-i18n="toolpage.heic.title">HEIC to JPG/PNG/WebP/GIF/BMP</h1>
      <p data-i18n="toolpage.heic.subtitle">Convert iPhone HEIC photos to JPG, PNG, WebP, GIF, or BMP locally.</p>
      <div class="hero-badges">
        <span class="badge" data-i18n="tool.feature.local">100% client-side processing</span>
        <span class="badge" data-i18n="tool.feature.private">Files never leave your device</span>
        <span class="badge" data-i18n="tool.feature.free">Free to use, no sign-up</span>
      </div>
    </section>

    <section class="converter">
      <div class="panel">
        <h2 data-i18n="heic.upload.title">Upload HEIC files</h2>
        <input id="heicInput" class="file-input" type="file" accept="image/heic,image/heif,.heic,.heif,image/*" multiple>
      <label id="dropZone" class="file-drop" for="heicInput">
        <span class="file-drop-title" data-i18n="heic.upload.hint">Drag &amp; drop or click to select</span>
          <span class="file-drop-note" data-i18n="heic.upload.note">HEIC/HEIF preferred. Other images supported. Output JPG/PNG/WebP/GIF/BMP.</span>
      </label>
      <div id="fileSummary" class="file-summary"></div>
      <div id="fileNames" class="file-names"></div>
      <div id="filePreview" class="file-preview"></div>

        <div class="options">
          <div class="option">
            <label for="heicFormat" data-i18n="heic.options.format">Output format</label>
            <select id="heicFormat">
              <option value="image/jpeg">JPG</option>
              <option value="image/png">PNG</option>
              <option value="image/webp">WebP</option>
              <option value="image/gif">GIF</option>
              <option value="image/bmp">BMP</option>
            </select>
          </div>
          <div class="option" id="qualityWrap">
            <label for="heicQuality" data-i18n="heic.options.quality">Output quality</label>
            <div class="quality-row">
              <input id="heicQuality" type="range" min="60" max="100" value="92">
              <span id="qualityValue" class="quality-value">92%</span>
            </div>
          </div>
        </div>

        <div class="actions">
          <button id="convertBtn" class="btn primary" data-i18n="heic.action.convert">Convert</button>
          <button id="clearBtn" class="btn" data-i18n="heic.action.clear">Clear</button>
        </div>
        <div id="heicStatus" class="status"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h2 id="resultsTitle" data-i18n="heic.results.title">Results</h2>
        </div>
        <div id="resultsEmpty" class="results-empty" data-i18n="heic.results.empty">Converted files will appear here.</div>
        <div id="resultsGrid" class="results-grid"></div>
      </div>
    </section>
  </main>

  <footer class="footer">© <span id="copyrightYear"></span> docdeskew.com</footer>

  <div id="cookieBanner" class="cookie-banner" role="dialog" aria-live="polite" aria-label="Cookie consent" hidden>
    <div class="cookie-text">
      <strong data-i18n="cookie.title">Cookies &amp; Analytics</strong>
      <span data-i18n="cookie.desc">We use Google Analytics to understand usage and improve the product. You can accept or reject analytics cookies.</span>
      <a class="cookie-link" href="../privacy.html" data-i18n="cookie.link">Learn more</a>
    </div>
    <div class="cookie-actions">
      <button id="cookieRejectBtn" class="cookie-btn" data-i18n="cookie.reject">Reject</button>
      <button id="cookieAcceptBtn" class="cookie-btn primary" data-i18n="cookie.accept">Accept</button>
    </div>
  </div>

  <script src="../assets/app.packed.js"></script>
  <script src="../assets/heic2any.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const t = (key, vars) => {
        if (typeof window.__DOC_DESKEW_T === 'function') {
          return window.__DOC_DESKEW_T(key, vars);
        }
        if (!vars) return key;
        return Object.entries(vars).reduce((acc, [k, v]) => acc.replaceAll(`{${k}}`, String(v)), key);
      };

      const input = document.getElementById('heicInput');
      const dropZone = document.getElementById('dropZone');
      const fileSummary = document.getElementById('fileSummary');
      const formatEl = document.getElementById('heicFormat');
      const qualityWrap = document.getElementById('qualityWrap');
      const qualityEl = document.getElementById('heicQuality');
      const qualityValue = document.getElementById('qualityValue');
      const convertBtn = document.getElementById('convertBtn');
      const clearBtn = document.getElementById('clearBtn');
      const statusEl = document.getElementById('heicStatus');
      const resultsGrid = document.getElementById('resultsGrid');
      const resultsEmpty = document.getElementById('resultsEmpty');
      const fileNames = document.getElementById('fileNames');
      const filePreview = document.getElementById('filePreview');

      let selectedFiles = [];
      let supportedFiles = [];
      let objectUrls = [];
      let previewUrls = [];
      const supportsWebp = (() => {
        try {
          const canvas = document.createElement('canvas');
          return canvas.toDataURL('image/webp').startsWith('data:image/webp');
        } catch {
          return false;
        }
      })();
      const supportsGif = Boolean(window.gifshot && typeof window.gifshot.createGIF === 'function');
      if (!supportsWebp && formatEl) {
        const webpOption = formatEl.querySelector('option[value="image/webp"]');
        if (webpOption) webpOption.remove();
        if (formatEl.value === 'image/webp') formatEl.value = 'image/jpeg';
      }
      if (!supportsGif && formatEl) {
        const gifOption = formatEl.querySelector('option[value="image/gif"]');
        if (gifOption) gifOption.remove();
        if (formatEl.value === 'image/gif') formatEl.value = 'image/jpeg';
      }

      const trackEvent = (name, params) => {
        if (typeof window.gtag === 'function') {
          window.gtag('event', name, params || {});
        }
      };

      const isHeic = (file) => {
        const name = String(file?.name || '').toLowerCase();
        const type = String(file?.type || '').toLowerCase();
        return name.endsWith('.heic') || name.endsWith('.heif') || type.includes('heic') || type.includes('heif');
      };

      const isImage = (file) => {
        const name = String(file?.name || '').toLowerCase();
        const type = String(file?.type || '').toLowerCase();
        if (type.startsWith('image/')) return true;
        return /\.(png|jpe?g|webp|gif|bmp)$/i.test(name);
      };

      const getKind = (file) => {
        if (isHeic(file)) return 'heic';
        if (isImage(file)) return 'image';
        return 'other';
      };

      const formatBytes = (bytes) => {
        if (!Number.isFinite(bytes) || bytes <= 0) return '0 B';
        const units = ['B', 'KB', 'MB', 'GB'];
        let value = bytes;
        let idx = 0;
        while (value >= 1024 && idx < units.length - 1) {
          value /= 1024;
          idx += 1;
        }
        return `${value.toFixed(value >= 10 || idx === 0 ? 0 : 1)} ${units[idx]}`;
      };

      const dataUrlToBlob = (dataUrl) => {
        if (typeof dataUrl !== 'string') return null;
        const parts = dataUrl.split(',');
        if (parts.length < 2) return null;
        const match = parts[0].match(/data:([^;]+);base64/);
        if (!match) return null;
        const mime = match[1];
        const binary = atob(parts[1]);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i += 1) {
          bytes[i] = binary.charCodeAt(i);
        }
        return new Blob([bytes], { type: mime });
      };

      const renderImageToCanvas = (blob) => new Promise((resolve, reject) => {
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = () => {
          const width = img.naturalWidth || img.width;
          const height = img.naturalHeight || img.height;
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          if (!ctx) {
            URL.revokeObjectURL(url);
            reject(new Error('Canvas not supported'));
            return;
          }
          ctx.drawImage(img, 0, 0);
          URL.revokeObjectURL(url);
          resolve({ canvas, width, height });
        };
        img.onerror = () => {
          URL.revokeObjectURL(url);
          reject(new Error('Failed to load image'));
        };
        img.src = url;
      });

      const canvasToBlob = (canvas, type, qualityValue) => new Promise((resolve, reject) => {
        canvas.toBlob((blob) => {
          if (!blob) {
            reject(new Error('Empty result'));
            return;
          }
          resolve(blob);
        }, type, qualityValue);
      });

      const convertImageViaCanvas = async (blob, type, qualityValue) => {
        const { canvas } = await renderImageToCanvas(blob);
        return canvasToBlob(canvas, type, qualityValue);
      };

      const convertCanvasToBmp = (canvas) => {
        const ctx = canvas.getContext('2d');
        if (!ctx) throw new Error('Canvas not supported');
        const { width, height } = canvas;
        const imageData = ctx.getImageData(0, 0, width, height);
        const rowStride = Math.floor((width * 3 + 3) / 4) * 4;
        const imageSize = rowStride * height;
        const fileSize = 54 + imageSize;
        const buffer = new ArrayBuffer(fileSize);
        const view = new DataView(buffer);
        let offset = 0;
        view.setUint8(offset++, 0x42);
        view.setUint8(offset++, 0x4d);
        view.setUint32(offset, fileSize, true);
        offset += 4;
        view.setUint16(offset, 0, true);
        offset += 2;
        view.setUint16(offset, 0, true);
        offset += 2;
        view.setUint32(offset, 54, true);
        offset += 4;
        view.setUint32(offset, 40, true);
        offset += 4;
        view.setInt32(offset, width, true);
        offset += 4;
        view.setInt32(offset, height, true);
        offset += 4;
        view.setUint16(offset, 1, true);
        offset += 2;
        view.setUint16(offset, 24, true);
        offset += 2;
        view.setUint32(offset, 0, true);
        offset += 4;
        view.setUint32(offset, imageSize, true);
        offset += 4;
        view.setInt32(offset, 0, true);
        offset += 4;
        view.setInt32(offset, 0, true);
        offset += 4;
        view.setUint32(offset, 0, true);
        offset += 4;
        view.setUint32(offset, 0, true);
        offset += 4;

        const data = new Uint8Array(buffer, 54);
        const pixels = imageData.data;
        for (let y = 0; y < height; y += 1) {
          const rowStart = y * rowStride;
          const srcRow = (height - 1 - y) * width * 4;
          for (let x = 0; x < width; x += 1) {
            const srcIdx = srcRow + x * 4;
            const destIdx = rowStart + x * 3;
            data[destIdx] = pixels[srcIdx + 2];
            data[destIdx + 1] = pixels[srcIdx + 1];
            data[destIdx + 2] = pixels[srcIdx];
          }
        }
        return new Blob([buffer], { type: 'image/bmp' });
      };

      const convertBlobToBmp = async (blob) => {
        const { canvas } = await renderImageToCanvas(blob);
        return convertCanvasToBmp(canvas);
      };

      const convertBlobToGif = async (blob) => {
        if (!supportsGif) throw new Error('GIF encoder not available');
        const { canvas, width, height } = await renderImageToCanvas(blob);
        const dataUrl = canvas.toDataURL('image/png');
        return new Promise((resolve, reject) => {
          window.gifshot.createGIF({
            images: [dataUrl],
            gifWidth: width,
            gifHeight: height,
            interval: 0.1,
            numFrames: 1,
            frameDuration: 1
          }, (result) => {
            if (result.error) {
              reject(new Error(result.errorMsg || result.errorMessage || 'GIF encoding failed'));
              return;
            }
            const gifBlob = dataUrlToBlob(result.image);
            if (!gifBlob) {
              reject(new Error('GIF encoding failed'));
              return;
            }
            resolve(gifBlob);
          });
        });
      };

      const clearResults = () => {
        objectUrls.forEach((url) => URL.revokeObjectURL(url));
        objectUrls = [];
        resultsGrid.innerHTML = '';
        resultsEmpty.hidden = false;
      };

      const clearPreview = () => {
        previewUrls.forEach((url) => URL.revokeObjectURL(url));
        previewUrls = [];
        if (filePreview) filePreview.innerHTML = '';
        if (fileNames) fileNames.innerHTML = '';
      };

      const setStatus = (key, vars) => {
        if (!statusEl) return;
        statusEl.textContent = t(key, vars);
      };

      const updateFileSummary = () => {
        if (!fileSummary) return;
        if (selectedFiles.length === 0) {
          fileSummary.textContent = '';
          return;
        }
        fileSummary.textContent = t('heic.file.count', { count: selectedFiles.length });
      };

      const updateFileNames = () => {
        if (!fileNames) return;
        fileNames.innerHTML = '';
        selectedFiles.forEach((file) => {
          const item = document.createElement('div');
          item.className = 'file-name-item';
          item.textContent = file.name || 'image';
          fileNames.appendChild(item);
        });
      };

      const addPreviewItem = (file, index) => {
        if (!filePreview) return;
        if (index >= 8) return;
        const card = document.createElement('div');
        card.className = 'file-preview-item';

        const thumb = document.createElement('div');
        thumb.className = 'file-thumb';
        thumb.textContent = (file.name || 'FILE').split('.').pop()?.toUpperCase() || 'FILE';

        const name = document.createElement('div');
        name.className = 'file-preview-name';
        name.textContent = file.name || 'image';

        card.appendChild(thumb);
        card.appendChild(name);
        filePreview.appendChild(card);

        const setThumb = (url) => {
          const img = document.createElement('img');
          img.src = url;
          img.alt = file.name || 'image';
          thumb.textContent = '';
          thumb.appendChild(img);
          previewUrls.push(url);
        };

        const kind = getKind(file);
        if (kind === 'heic' && typeof window.heic2any === 'function') {
          window.heic2any({
            blob: file,
            toType: 'image/jpeg',
            quality: 0.6
          }).then((output) => {
            const blob = Array.isArray(output) ? output[0] : output;
            if (!blob) return;
            setThumb(URL.createObjectURL(blob));
          }).catch(() => {
            // keep placeholder
          });
        } else if (kind === 'image') {
          setThumb(URL.createObjectURL(file));
        }
      };

      const lossyFormats = new Set(['image/jpeg', 'image/webp']);

      const updateQualityUI = () => {
        if (!qualityEl || !qualityValue || !qualityWrap || !formatEl) return;
        const isLossy = lossyFormats.has(formatEl.value);
        qualityWrap.style.display = isLossy ? 'block' : 'none';
        qualityValue.textContent = `${qualityEl.value}%`;
      };

      const updateSelectedFiles = (files) => {
        selectedFiles = files;
        supportedFiles = selectedFiles.filter((file) => getKind(file) !== 'other');
        updateFileSummary();
        clearPreview();
        updateFileNames();
        selectedFiles.forEach(addPreviewItem);
        if (selectedFiles.length === 0) {
          setStatus('heic.status.noFiles');
        } else if (supportedFiles.length === 0) {
          setStatus('heic.status.unsupported');
        } else {
          setStatus('heic.status.ready');
        }
      };

      const convertFiles = async () => {
        if (supportedFiles.length === 0) {
          setStatus(selectedFiles.length ? 'heic.status.unsupported' : 'heic.status.noFiles');
          return;
        }
        const hasHeic = supportedFiles.some((file) => getKind(file) === 'heic');
        if (hasHeic && typeof window.heic2any !== 'function') {
          setStatus('heic.status.missing');
          return;
        }

        clearResults();
        resultsEmpty.hidden = true;
        convertBtn.disabled = true;

        const outputType = formatEl.value;
        const extMap = {
          'image/png': 'png',
          'image/jpeg': 'jpg',
          'image/webp': 'webp',
          'image/gif': 'gif',
          'image/bmp': 'bmp'
        };
        const ext = extMap[outputType] || 'jpg';
        const quality = lossyFormats.has(outputType) ? Number(qualityEl.value) / 100 : 1;
        const started = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
        let converted = 0;

        for (let i = 0; i < supportedFiles.length; i += 1) {
          const file = supportedFiles[i];
          setStatus('heic.status.converting', { current: i + 1, total: supportedFiles.length });
          try {
            const kind = getKind(file);
            let blob = null;
            if (kind === 'heic') {
              const heicToType = outputType === 'image/jpeg' ? 'image/jpeg' : 'image/png';
              const heicQuality = heicToType === 'image/jpeg' ? quality : 1;
              const output = await window.heic2any({
                blob: file,
                toType: heicToType,
                quality: heicQuality
              });
              const baseBlob = Array.isArray(output) ? output[0] : output;
              if (!baseBlob) throw new Error('Empty result');
              if (outputType === 'image/webp') {
                blob = await convertImageViaCanvas(baseBlob, 'image/webp', quality);
              } else if (outputType === 'image/gif') {
                blob = await convertBlobToGif(baseBlob);
              } else if (outputType === 'image/bmp') {
                blob = await convertBlobToBmp(baseBlob);
              } else {
                blob = baseBlob;
              }
            } else {
              if (outputType === 'image/gif') {
                const baseBlob = await convertImageViaCanvas(file, 'image/png', 1);
                blob = await convertBlobToGif(baseBlob);
              } else if (outputType === 'image/bmp') {
                const baseBlob = await convertImageViaCanvas(file, 'image/png', 1);
                blob = await convertBlobToBmp(baseBlob);
              } else {
                blob = await convertImageViaCanvas(file, outputType, quality);
              }
            }
            if (!blob) throw new Error('Empty result');

            const url = URL.createObjectURL(blob);
            objectUrls.push(url);

            const baseName = String(file.name || 'image').replace(/\.[^/.]+$/, '') || 'image';
            const filename = `${baseName}.${ext}`;

            const card = document.createElement('div');
            card.className = 'result-item';

            const img = document.createElement('img');
            img.src = url;
            img.alt = filename;

            const meta = document.createElement('div');
            meta.className = 'result-meta';

            const nameEl = document.createElement('div');
            nameEl.className = 'result-name';
            nameEl.textContent = filename;

            const sizeEl = document.createElement('div');
            sizeEl.className = 'result-size';
            sizeEl.textContent = formatBytes(blob.size);

            meta.appendChild(nameEl);
            meta.appendChild(sizeEl);

            const link = document.createElement('a');
            link.className = 'result-download';
            link.textContent = t('heic.results.download');
            link.href = url;
            link.download = filename;
            link.addEventListener('click', () => {
              trackEvent('file_download', { tool_name: 'heic', output_type: ext });
            });

            card.appendChild(img);
            card.appendChild(meta);
            card.appendChild(link);
            resultsGrid.appendChild(card);

            converted += 1;
          } catch (err) {
            setStatus('heic.status.error', { name: file.name || 'file' });
          }
        }

        const finished = (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now();
        const duration = Math.max(0, Math.round(finished - started));
        if (converted > 0) {
          trackEvent('process_complete', {
            tool_name: 'heic',
            duration_ms: duration,
            output_type: ext
          });
        }
        setStatus('heic.status.done', { count: converted });
        convertBtn.disabled = false;
        resultsEmpty.hidden = resultsGrid.children.length > 0;

        const resultsTitle = document.getElementById('resultsTitle');
        if (resultsTitle) {
          const offset = 72;
          const top = resultsTitle.getBoundingClientRect().top + window.scrollY - offset;
          window.scrollTo({ top: Math.max(0, top), behavior: 'smooth' });
        }
      };

      input.addEventListener('change', (e) => {
        const files = Array.from(e.target.files || []);
        updateSelectedFiles(files);
        if (files.length > 0) {
          const type = files.some(isHeic) ? 'heic' : 'image';
          trackEvent('file_upload', { tool_name: 'heic', file_type: type });
        }
      });

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag');
      });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag'));
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag');
        const files = Array.from(e.dataTransfer.files || []);
        updateSelectedFiles(files);
        if (files.length > 0) {
          const type = files.some(isHeic) ? 'heic' : 'image';
          trackEvent('file_upload', { tool_name: 'heic', file_type: type });
        }
      });

      formatEl.addEventListener('change', updateQualityUI);
      qualityEl.addEventListener('input', updateQualityUI);
      convertBtn.addEventListener('click', convertFiles);
      clearBtn.addEventListener('click', () => {
        selectedFiles = [];
        supportedFiles = [];
        input.value = '';
        clearResults();
        clearPreview();
        updateFileSummary();
        setStatus('heic.status.noFiles');
      });

      updateQualityUI();
      setStatus('heic.status.ready');
    });
  </script>
</body>

</html>
